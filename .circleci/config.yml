version: 2.1

executors:
  docker_executor:
    docker:
      - image: circleci/ruby:2.7.1-buster-node

jobs:
  setup:
    executor: docker_executor
    steps:
      - checkout
      - run:
          name: Set up environment
          command: |
            ./bin/setup
            ls -la /home/circleci
            ls -la /home/circleci/project
            ls -la /home/circleci/project/_assets
            ls -la /home/circleci/project/_assets/yarn
  test:
    executor: docker_executor
    steps:
      - checkout
      - run:
          name: Run tests
          command: |
            ./bin/setup
            bundle install
            ls -la /home/circleci
            ls -la /home/circleci/project
            ls -la /home/circleci/project/_assets
            ls -la /home/circleci/project/_assets/yarn
            bundle exec jekyll build
            rm -R ./_site/node_modules
            bundle exec htmlproofer ./_site --only-4xx --allow-hash-href --assume-extension --check-opengraph --url-ignore "feed.xml"

workflows:
  version: 2.1
  test_all:
    jobs:
      - setup
      - test:
          requires:
          - setup
